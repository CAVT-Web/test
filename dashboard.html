<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>📋 صفحة الحجوزات</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Segoe UI'; direction: rtl; background-color: #fafafa; padding: 20px; }

    #navbar {
      background:#007bff; padding:10px; color:white;
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:20px;
    }
    #navbar a { color:white; margin-right:15px; text-decoration:none; }
    #navbar a:hover { text-decoration: underline; }
    #navbar div:last-child { font-weight:bold; }

    .search-box { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    input, button { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; }
    button { cursor: pointer; background-color: #007bff; color: white; font-weight: bold; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #007bff; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }

    .edit-btn { background-color: #28a745; color:white; border:none; padding:5px 10px; border-radius:5px; margin: 2px; }
    .delete-btn { background-color: #dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; margin: 2px; }
  </style>
</head>
<body>

  <!-- شريط التنقل -->
  <div id="navbar">
    <div>
      <a href="index.html">🚗 الحجز</a>
      <a href="dashboard.html">📋 الحجوزات</a>
      <a href="settings.html">⚙️ الإعدادات</a>
    </div>
    <div>
      👤 مرحبًا، <span id="usernameDisplay"></span>
      <a href="#" onclick="logout()" style="color:#ffdddd; margin-right:15px;">🚪 خروج</a>
    </div>
  </div>

  <h2>📋 الحجوزات الحالية</h2>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="🔎 بحث بالاسم أو السيارة أو الموقع">
    <input type="date" id="dateFilter">
    <button onclick="exportToCSV()">📤 تصدير CSV</button>
    <button onclick="exportToPDF()">📄 تصدير PDF</button>
  </div>

  <div id="bookingCount"></div>

  <table id="bookingsTable">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>الهاتف</th>
        <th>السيارة</th>
        <th>من</th>
        <th>إلى</th>
        <th>الموقع</th>
        <th>عدد الأيام</th>
        <th>السعر</th>
        <th>التحكم</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // حماية الصفحة
    if (localStorage.getItem("isLoggedIn") !== "true") {
      alert("🔐 يرجى تسجيل الدخول أولاً");
      window.location.href = "login.html";
    }

    const username = localStorage.getItem("loggedUser") || "مستخدم";
    document.getElementById("usernameDisplay").textContent = username;

    function logout() {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("loggedUser");
      window.location.href = "login.html";
    }

    // تحميل وعرض الحجوزات
    let bookings = JSON.parse(localStorage.getItem("bookings") || "[]");
    const tbody = document.querySelector("#bookingsTable tbody");
    const searchInput = document.getElementById("searchInput");
    const dateFilter = document.getElementById("dateFilter");
    const bookingCount = document.getElementById("bookingCount");

    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach((booking, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${booking.name}</td>
          <td>${booking.phone}</td>
          <td>${booking.car}</td>
          <td>${booking.start}</td>
          <td>${booking.end}</td>
          <td>${booking.location}</td>
          <td>${booking.duration.replace("عدد الأيام: ","")}</td>
          <td>${booking.total.replace("السعر الإجمالي: ","")}</td>
          <td>
            <button class="edit-btn" onclick="editBooking(${index})">تعديل</button>
            <button class="delete-btn" onclick="deleteBooking(${index})">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      bookingCount.textContent = `🔢 عدد الحجوزات: ${data.length}`;
    }

    function filterBookings() {
      const keyword = searchInput.value.toLowerCase();
      const filterDate = dateFilter.value;
      const filtered = bookings.filter(b => {
        const matchesKeyword = b.name.toLowerCase().includes(keyword) || 
                               b.car.toLowerCase().includes(keyword) || 
                               b.location.toLowerCase().includes(keyword);
        const matchesDate = filterDate ? b.start === filterDate || b.end === filterDate : true;
        return matchesKeyword && matchesDate;
      });
      renderTable(filtered);
    }

    function deleteBooking(index) {
      if (confirm("🗑 هل أنت متأكد أنك تريد حذف هذا الحجز؟")) {
        bookings.splice(index, 1);
        localStorage.setItem("bookings", JSON.stringify(bookings));
        filterBookings();
      }
    }

    function editBooking(index) {
      const data = bookings[index];
      localStorage.setItem("editBooking", JSON.stringify({ ...data, index }));
      window.location.href = "index.html";
    }

    function exportToCSV() {
      const csvRows = [["الاسم", "الهاتف", "السيارة", "من", "إلى", "الموقع", "عدد الأيام", "السعر"]];
      bookings.forEach(b => {
        csvRows.push([
          b.name, b.phone, b.car, b.start, b.end,
          b.location,
          b.duration.replace("عدد الأيام: ",""),
          b.total.replace("السعر الإجمالي: ","")
        ]);
      });
      const csvContent = csvRows.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "الحجوزات.csv";
      link.click();
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape", unit: "pt", format: "a4" });

      doc.setFontSize(16);
      doc.text("📋 قائمة الحجوزات", 40, 40);

      const headers = [["الاسم", "الهاتف", "السيارة", "من", "إلى", "الموقع", "عدد الأيام", "السعر"]];
      const dataRows = bookings.map(b => [
        b.name, b.phone, b.car, b.start, b.end,
        b.location,
        b.duration.replace("عدد الأيام: ",""),
        b.total.replace("السعر الإجمالي: ","")
      ]);

      const allRows = headers.concat(dataRows);
      let y = 70;
      allRows.forEach((row, i) => {
        let x = 40;
        row.forEach(cell => {
          doc.text(String(cell), x, y);
          x += 100;
        });
        y += 25;
        if (y > 550) {
          doc.addPage();
          y = 40;
        }
      });

      doc.save("الحجوزات.pdf");
    }

    searchInput.addEventListener("input", filterBookings);
    dateFilter.addEventListener("change", filterBookings);

    // عرض أولي
    renderTable(bookings);
  </script>

</body>
</html>